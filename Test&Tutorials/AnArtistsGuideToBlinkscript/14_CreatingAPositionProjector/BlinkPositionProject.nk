set cut_paste_input [stack 0]
version 12.2 v1
push $cut_paste_input
Group {
 name BlinkPositionProject
 tile_color 0xa379aaff
 label "(\[value outputType])\nFrame: \[value project_frame]"
 selected true
 xpos 45
 ypos -134
 addUserKnob {20 BlinkPositionProject}
 addUserKnob {41 "Local GPU: " T BlinkScript2.gpuName}
 addUserKnob {41 "Use GPU if Available" T BlinkScript2.useGPUIfAvailable}
 addUserKnob {41 vectorize l "Vectorize on CPU" -STARTLINE T BlinkScript2.vectorize}
 addUserKnob {26 ""}
 addUserKnob {4 outputType l "Output Type" M {"Projected Image" STMap Depth "Motion Blur" ""}}
 addUserKnob {26 ""}
 addUserKnob {41 BlinkPositionProject_iterations l "Motion Blur Steps" T BlinkScript2.BlinkPositionProject_iterations}
 addUserKnob {41 BlinkPositionProject_shutter l Shutter T BlinkScript2.BlinkPositionProject_shutter}
 addUserKnob {26 ""}
 addUserKnob {3 project_frame l "Projection Frame"}
 project_frame 1
 addUserKnob {22 setCurrentFrame l "Set Current Frame" -STARTLINE T "nuke.thisNode()\['project_frame'].setValue(nuke.frame())"}
 addUserKnob {41 BlinkPositionProject_vMult l "Vertical Aperture Scale" T BlinkScript2.BlinkPositionProject_vMult}
 addUserKnob {26 ""}
 addUserKnob {26 credit l "" +STARTLINE T "Chris Fryer | 2020 | In Progress"}
}
 Input {
  inputs 0
  name pos
  xpos 2296
  ypos 164
  number 1
 }
 Input {
  inputs 0
  name img
  xpos 2114
  ypos 138
 }
 BlinkScript {
  inputs 2
  recompileCount 782
  ProgramGroup 1
  KernelDescription "2 \"BlinkPositionProject\" iterate pixelWise 1153f419efefb4913f866e9e5f22fb9aa1ca5857de69a86f25d3a46a39bdf4e6 3 \"src\" Read Random \"pos\" Read Random \"dst\" Write Random 24 \"iterations\" Int 1 AAAAAA== \"timeOffsetSlider\" Float 1 AAAAAA== \"shutter\" Float 1 AAAAAA== \"resolution\" Float 2 AAAAAAAAAAA= \"outputSTMap\" Bool 1 AA== \"outputDepth\" Bool 1 AA== \"output_type\" Int 1 AAAAAA== \"focal\" Float 1 AAAAAA== \"haperture\" Float 1 AAAAAA== \"vaperture\" Float 1 AAAAAA== \"matrix\" Float 16 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA== \"focalAnimated\" Float 1 AAAAAA== \"hapertureAnimated\" Float 1 AAAAAA== \"vapertureAnimated\" Float 1 AAAAAA== \"matrixAnimated\" Float 16 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA== \"focalNext\" Float 1 AAAAAA== \"hapertureNext\" Float 1 AAAAAA== \"vapertureNext\" Float 1 AAAAAA== \"matrixNext\" Float 16 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA== \"focalPrev\" Float 1 AAAAAA== \"haperturePrev\" Float 1 AAAAAA== \"vaperturePrev\" Float 1 AAAAAA== \"matrixPrev\" Float 16 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA== \"vMult\" Float 1 AAAAAA== 24 \"iterations\" 1 1 \"timeOffsetSlider\" 1 1 \"shutter\" 1 1 \"resolution\" 2 1 \"outputSTMap\" 1 1 \"outputDepth\" 1 1 \"output_type\" 1 1 \"focal\" 1 1 \"haperture\" 1 1 \"vaperture\" 1 1 \"matrix\" 16 1 \"focalAnimated\" 1 1 \"hapertureAnimated\" 1 1 \"vapertureAnimated\" 1 1 \"matrixAnimated\" 16 1 \"focalNext\" 1 1 \"hapertureNext\" 1 1 \"vapertureNext\" 1 1 \"matrixNext\" 16 1 \"focalPrev\" 1 1 \"haperturePrev\" 1 1 \"vaperturePrev\" 1 1 \"matrixPrev\" 16 1 \"vMult\" 1 1 0"
  kernelSource "kernel BlinkPositionProject : ImageComputationKernel<ePixelWise>\n\{\n  Image<eRead, eAccessRandom, eEdgeClamped> src;\n  Image<eRead, eAccessRandom, eEdgeClamped> pos;\n  \n  Image<eWrite, eAccessRandom, eEdgeClamped> dst;\n\n  param:\n   \n    int iterations;\n    float timeOffsetSlider;\n    float shutter;\n\n    float2 resolution;\n    bool outputSTMap;  \n    bool outputDepth;  \n    int output_type;\n\n    float focal;\n    float haperture;\n    float vaperture;\n    float4x4 matrix;\n\n    float focalAnimated;\n    float hapertureAnimated;\n    float vapertureAnimated;\n    float4x4 matrixAnimated;\n\n    float focalNext;\n    float hapertureNext;\n    float vapertureNext;\n    float4x4 matrixNext;\n\n    float focalPrev;\n    float haperturePrev;\n    float vaperturePrev;\n    float4x4 matrixPrev;\n\n    float vMult;\n  \n\n  void process(int2 position) \{  \n\n    float3 output;\n    float4 posDifference;\n   \n    posDifference.x = pos(position.x,position.y).x - matrix\[0]\[3];\n    posDifference.y = pos(position.x,position.y).y - matrix\[1]\[3];\n    posDifference.z = pos(position.x,position.y).z - matrix\[2]\[3]; \n    posDifference.w = pow(pow(posDifference.x,2)+pow(posDifference.y,2)+pow(posDifference.z,2),0.5f);\n\n    float xCoords = matrix\[0]\[0]*posDifference.x + matrix\[1]\[0]*posDifference.y + matrix\[2]\[0]*posDifference.z;\n    float yCoords = matrix\[0]\[1]*posDifference.x + matrix\[1]\[1]*posDifference.y + matrix\[2]\[1]*posDifference.z;\n    float zCoords = matrix\[0]\[2]*posDifference.x + matrix\[1]\[2]*posDifference.y + matrix\[2]\[2]*posDifference.z;\n\n    float4 uv;\n    uv.x = 0.5f - (xCoords * ((focal/(haperture))/zCoords));\n    uv.y = 0.5f - (yCoords * ((focal/(vaperture*vMult))/zCoords));\n    uv.z = 1;\n\n     \n\n    float4 uvScaled;\n\n    uvScaled.x = uv.x*resolution.x;\n    uvScaled.y = uv.y*resolution.y;\n\n\n\n/////////////////////////////////////////////////////////\n\n    float4 nextPosDifference;\n   \n    nextPosDifference.x = pos(position.x,position.y).x - matrixNext\[0]\[3];\n    nextPosDifference.y = pos(position.x,position.y).y - matrixNext\[1]\[3];\n    nextPosDifference.z = pos(position.x,position.y).z - matrixNext\[2]\[3]; \n    nextPosDifference.w = pow(pow(nextPosDifference.x,2)+pow(nextPosDifference.y,2)+pow(nextPosDifference.z,2),0.5f);\n\n    float nextXCoords = matrixNext\[0]\[0]*nextPosDifference.x + matrixNext\[1]\[0]*nextPosDifference.y + matrixNext\[2]\[0]*nextPosDifference.z;\n    float nextYCoords = matrixNext\[0]\[1]*nextPosDifference.x + matrixNext\[1]\[1]*nextPosDifference.y + matrixNext\[2]\[1]*nextPosDifference.z;\n    float nextZCoords = matrixNext\[0]\[2]*nextPosDifference.x + matrixNext\[1]\[2]*nextPosDifference.y + matrixNext\[2]\[2]*nextPosDifference.z;\n\n    float4 nextUV;\n    nextUV.x = 0.5f - (nextXCoords * ((focalNext/(hapertureNext))/nextZCoords));\n    nextUV.y = 0.5f - (nextYCoords * ((focalNext/(vapertureNext*vMult))/nextZCoords));\n    nextUV.z = 1;\n\n     \n\n    float4 nextUVScaled;\n\n    nextUVScaled.x = nextUV.x*resolution.x;\n    nextUVScaled.y = nextUV.y*resolution.y;\n    \n///////////////////////////////////////////////////\n\n    float4 prevPosDifference;\n\n    prevPosDifference.x = pos(position.x,position.y).x - matrixPrev\[0]\[3];\n    prevPosDifference.y = pos(position.x,position.y).y - matrixPrev\[1]\[3];\n    prevPosDifference.z = pos(position.x,position.y).z - matrixPrev\[2]\[3]; \n    prevPosDifference.w = pow(pow(prevPosDifference.x,2)+pow(prevPosDifference.y,2)+pow(prevPosDifference.z,2),0.5f);\n\n    float prevXCoords = matrixPrev\[0]\[0]*prevPosDifference.x + matrixPrev\[1]\[0]*prevPosDifference.y + matrixPrev\[2]\[0]*prevPosDifference.z;\n    float prevYCoords = matrixPrev\[0]\[1]*prevPosDifference.x + matrixPrev\[1]\[1]*prevPosDifference.y + matrixPrev\[2]\[1]*prevPosDifference.z;\n    float prevZCoords = matrixPrev\[0]\[2]*prevPosDifference.x + matrixPrev\[1]\[2]*prevPosDifference.y + matrixPrev\[2]\[2]*prevPosDifference.z;\n\n    float4 prevUV;\n    prevUV.x = 0.5f - (prevXCoords * ((focalPrev/(haperturePrev))/prevZCoords));\n    prevUV.y = 0.5f - (prevYCoords * ((focalPrev/(vaperturePrev*vMult))/prevZCoords));\n    prevUV.z = 1;\n\n     \n\n    float4 prevUVScaled;\n\n    prevUVScaled.x = prevUV.x*resolution.x;\n    prevUVScaled.y = prevUV.y*resolution.y;\n\n///////////////////////////////////////////////////\n\n\n    float4 projectedOutput;\n    projectedOutput = bilinear(src,uv.x*resolution.x,uv.y*resolution.y);\n\n\n\n    if (output_type == 1) \{       \n      \n    \n        dst(position.x,position.y)= uv;\n        \n\n    \} else if (output_type == 2) \{\n\n        dst(position.x,position.y)= posDifference.w;\n        \n    \} else if (output_type == 3) \{\n\n         float4 moBlurredOutput;\n         float4 currentUV;\n         float4 inverseUV;\n\n        //dst(prevUVScaled.x,prevUVScaled.y) = projectedOutput;\n        //dst(nextUVScaled.x,nextUVScaled.y) = projectedOutput;\n\n        for (float i = 0.0f; i < iterations; i++) \{\n\n          \n          currentUV = prevUVScaled-(prevUVScaled-nextUVScaled)*(i/iterations);\n          inverseUV.x = (position.x)+(currentUV.x-position.x+.5f)*(shutter/2);\n          inverseUV.y = (position.y)+(currentUV.y-position.y+.5f)*(shutter/2);\n          \n          dst(inverseUV.x,inverseUV.y) += projectedOutput/iterations;\n          //moBlurredOutput+= dst(position.x,position.y);\n\n        \}\n\n        dst(position.x,position.y) = moBlurredOutput;\n\n\n          \n          \n        \n\n        \n\n    \} else \{\n        \n        dst(position.x,position.y)= projectedOutput;\n\n    \}\n  \}   \n\n  \n\};"
  useGPUIfAvailable false
  rebuild ""
  BlinkPositionProject_iterations 10
  BlinkPositionProject_shutter 0.5
  BlinkPositionProject_resolution {{width} {height}}
  BlinkPositionProject_outputDepth true
  BlinkPositionProject_output_type {{parent.outputType}}
  BlinkPositionProject_focal {{"\[if \{\[exists input3] == 0\} \{return \"parent.Camera4.focal(project_frame)\"\} else \{return \"parent.Camera1.focal(project_frame)\"\}]"}}
  BlinkPositionProject_haperture {{"\[if \{\[exists input3] == 0\} \{return \"parent.Camera4.haperture(project_frame)\"\} else \{return \"parent.Camera1.haperture(project_frame)\"\}]"}}
  BlinkPositionProject_vaperture {{"\[if \{\[exists input3] == 0\} \{return \"parent.Camera4.vaperture(project_frame)\"\} else \{return \"parent.Camera1.vaperture(project_frame)\"\}]"}}
  BlinkPositionProject_matrix {
      {{"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"}}
      {{"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"}}
      {{"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"}}
      {{"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"} {"\[if \{\[exists input3] == 0\} \{return \"\[topnode parent.input2].world_matrix(project_frame)\"\} else \{return \"\[topnode parent.input3].world_matrix(project_frame)\"\}]"}}
    }
  BlinkPositionProject_focalAnimated {{parent.Camera4.focal}}
  BlinkPositionProject_hapertureAnimated {{parent.Camera4.haperture}}
  BlinkPositionProject_vapertureAnimated {{parent.Camera4.vaperture}}
  BlinkPositionProject_matrixAnimated {
      {{parent.Camera4.matrix} {parent.Camera4.matrix} {parent.Camera4.matrix} {parent.Camera4.matrix}}
      {{parent.Camera4.matrix} {parent.Camera4.matrix} {parent.Camera4.matrix} {parent.Camera4.matrix}}
      {{parent.Camera4.matrix} {parent.Camera4.matrix} {parent.Camera4.matrix} {parent.Camera4.matrix}}
      {{parent.Camera4.matrix} {parent.Camera4.matrix} {parent.Camera4.matrix} {parent.Camera4.matrix}}
    }
  BlinkPositionProject_focalNext {{BlinkPositionProject_focalAnimated(frame+1)}}
  BlinkPositionProject_hapertureNext {{BlinkPositionProject_hapertureAnimated(frame+1)}}
  BlinkPositionProject_vapertureNext {{BlinkPositionProject_vapertureAnimated(frame+1)}}
  BlinkPositionProject_matrixNext {
      {{BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)}}
      {{BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)}}
      {{BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)}}
      {{BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)} {BlinkPositionProject_matrixAnimated(frame+1)}}
    }
  BlinkPositionProject_focalPrev {{BlinkPositionProject_focalAnimated(frame-1)}}
  BlinkPositionProject_haperturePrev {{BlinkPositionProject_hapertureAnimated(frame-1)}}
  BlinkPositionProject_vaperturePrev {{BlinkPositionProject_vapertureAnimated(frame-1)}}
  BlinkPositionProject_matrixPrev {
      {{BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)}}
      {{BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)}}
      {{BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)}}
      {{BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)} {BlinkPositionProject_matrixAnimated(frame-1)}}
    }
  BlinkPositionProject_vMult 1
  rebuild_finalise ""
  name BlinkScript2
  xpos 2114
  ypos 328
 }
 Output {
  name Output1
  xpos 2114
  ypos 412
 }
 Input {
  inputs 0
  name cam
  xpos 1973
  ypos 127
  number 2
 }
 Input {
  inputs 0
  name altCam
  xpos 1809
  ypos 139
  number 3
 }
 Camera2 {
  inputs 0
  useMatrix true
  matrix {
      {{"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"}}
      {{"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"}}
      {{"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"}}
      {{"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"} {"\[topnode parent.input3].world_matrix"}}
    }
  focal {{"\[topnode parent.input3].focal (parent.project_frame)"}}
  haperture {{"\[topnode parent.input3].haperture (parent.project_frame)"}}
  vaperture {{"\[topnode parent.input3].vaperture (parent.project_frame)"}}
  name Camera1
  xpos 1818
  ypos 262
 }
 Camera2 {
  inputs 0
  useMatrix true
  matrix {
      {{"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"}}
      {{"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"}}
      {{"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"}}
      {{"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"} {"\[topnode parent.input2].world_matrix"}}
    }
  focal {{"\[topnode parent.input2].focal "}}
  haperture {{"\[topnode parent.input2].haperture "}}
  vaperture {{"\[topnode parent.input2].vaperture"}}
  name Camera4
  xpos 1933
  ypos 240
 }
end_group
